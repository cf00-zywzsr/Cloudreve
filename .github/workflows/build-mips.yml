name: Build Cloudreve for MT7621

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        submodules: recursive

    - name: Clean package locks
      run: rm -f package-lock.json

    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20.x'

    - name: Setup Go
      uses: actions/setup-go@v5
      with:
        go-version: '1.21'

    - name: Install dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y zip build-essential file
        npm install -g yarn
        go install github.com/goreleaser/goreleaser@v1.19.2

    - name: Verify Go environment
      run: |
        go env
        echo "GOARCH=$GOARCH"
        echo "GOOS=$GOOS"

    - name: Build Frontend
      run: |
        cd assets
        yarn install
        yarn build

    - name: Configure GoReleaser
      run: |
        cat <<EOF > .goreleaser.yaml
        builds:
          - id: mt7621
            binary: cloudreve
            no_unique_dist_dir: true
            env:
              - CGO_ENABLED=0
              - GOARCH=mips
              - GOOS=linux
              - GOMIPS=softfloat
            flags:
              - -trimpath
            ldflags:
              - -s -w
            goos:
              - linux
            goarch:
              - mips
            gomips:
              - softfloat
        EOF

    - name: Build Cloudreve
      run: |
        go mod tidy
        ~/go/bin/goreleaser build \
          --clean \
          --single-target \
          --snapshot \
          --id mt7621

    - name: Verify Binary
      run: |
        file dist/cloudreve
        ls -lh dist/cloudreve

    - name: Upload artifact
      uses: actions/upload-artifact@v4
      with:
        name: cloudreve-mt7621
        path: dist/cloudreve
